CREATE DATABASE IF NOT EXISTS codex_humanitas_;
USE codex_humanitas_;

CREATE TABLE tipo_membro (
    id_tipo_membro SERIAL PRIMARY KEY,
    nome VARCHAR(50) NOT NULL UNIQUE,
    limite_emprestimos INT NOT NULL CHECK (limite_emprestimos > 0),
    prazo_devolucao_dias INT NOT NULL CHECK (prazo_devolucao_dias > 0)
);

CREATE TABLE membro (
    matricula VARCHAR(20) PRIMARY KEY,
    nome VARCHAR(100) NOT NULL,
    email VARCHAR(100) NOT NULL UNIQUE,
    telefone VARCHAR(20),
    id_tipo_membro INT NOT NULL,
    CONSTRAINT fk_membro_tipo
        FOREIGN KEY (id_tipo_membro)
        REFERENCES tipo_membro (id_tipo_membro)
);

CREATE TABLE livro (
    isbn VARCHAR(20) PRIMARY KEY,
    titulo VARCHAR(200) NOT NULL,
    editora VARCHAR(100),
    ano_publicacao INT CHECK (ano_publicacao >= 0)
);

CREATE TABLE autor (
    id_autor SERIAL PRIMARY KEY,
    nome VARCHAR(100) NOT NULL,
    nacionalidade VARCHAR(50)
);

CREATE TABLE livro_autor (
    isbn VARCHAR(20) NOT NULL,
    id_autor INT NOT NULL,
    PRIMARY KEY (isbn, id_autor),
    CONSTRAINT fk_la_livro
        FOREIGN KEY (isbn) REFERENCES livro (isbn),
    CONSTRAINT fk_la_autor
        FOREIGN KEY (id_autor) REFERENCES autor (id_autor)
);

CREATE TABLE categoria (
    id_categoria SERIAL PRIMARY KEY,
    nome VARCHAR(100) NOT NULL UNIQUE
);

CREATE TABLE livro_categoria (
    isbn BIGINT(20) NOT NULL,
    id_categoria INT NOT NULL,
    PRIMARY KEY (isbn, id_categoria),
    CONSTRAINT fk_lc_livro
        FOREIGN KEY (isbn) REFERENCES livro (isbn),
    CONSTRAINT fk_lc_categoria
        FOREIGN KEY (id_categoria) REFERENCES categoria (id_categoria)
);

CREATE TABLE exemplar (
    codigo_barras VARCHAR(30) PRIMARY KEY,
    isbn VARCHAR(20) NOT NULL,
    localizacao VARCHAR(50) NOT NULL,
    status VARCHAR(15) NOT NULL,
    CONSTRAINT fk_exemplar_livro
        FOREIGN KEY (isbn) REFERENCES livro (isbn),
    CONSTRAINT chk_exemplar_status
        CHECK (status IN ('Disponível', 'Emprestado', 'Manutenção'))
);

CREATE TABLE emprestimo (
    id_emprestimo SERIAL PRIMARY KEY,
    codigo_barras VARCHAR(30) NOT NULL,
    matricula_membro VARCHAR(20) NOT NULL,
    data_emprestimo DATE NOT NULL,
    data_devolucao_prevista DATE NOT NULL,
    data_devolucao_efetiva DATE,
    CONSTRAINT fk_emp_exemplar
        FOREIGN KEY (codigo_barras) REFERENCES exemplar (codigo_barras),
    CONSTRAINT fk_emp_membro
        FOREIGN KEY (matricula_membro) REFERENCES membro (matricula),
    CONSTRAINT chk_datas_emprestimo
        CHECK (data_devolucao_prevista >= data_emprestimo)
);

CREATE TABLE reserva (
    id_reserva SERIAL PRIMARY KEY,
    isbn VARCHAR(20) NOT NULL,
    matricula_membro VARCHAR(20) NOT NULL,
    data_reserva DATE NOT NULL,
    CONSTRAINT fk_res_livro
        FOREIGN KEY (isbn) REFERENCES livro (isbn),
    CONSTRAINT fk_res_membro
        FOREIGN KEY (matricula_membro) REFERENCES membro (matricula)
);

CREATE TABLE log_emprestimos (
    id_log SERIAL PRIMARY KEY,
    id_emprestimo INT NOT NULL,
    codigo_barras VARCHAR(30) NOT NULL,
    matricula_membro VARCHAR(20) NOT NULL,
    data_emprestimo DATE NOT NULL,
    data_registro TIMESTAMP NOT NULL DEFAULT now()
);
